<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#ff6b35">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="MathUp">
<meta name="description" content="Matematica 2Âª Media â€“ DSA Friendly â€“ by Valerio Spiga">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>MathUp â€“ Matematica DSA</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Nunito+Sans:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #fef9f0;
  --card: #ffffff;
  --primary: #ff6b35;
  --primary-light: #fff0eb;
  --primary-dark: #e55527;
  --accent: #4ecdc4;
  --accent-light: #e8faf9;
  --purple: #8b5cf6;
  --purple-light: #f5f3ff;
  --green: #22c55e;
  --green-light: #f0fdf4;
  --yellow: #f59e0b;
  --yellow-light: #fffbeb;
  --blue: #3b82f6;
  --blue-light: #eff6ff;
  --red: #ef4444;
  --text: #1e293b;
  --text-light: #64748b;
  --border: #e2e8f0;
  --shadow: 0 4px 24px rgba(0,0,0,0.07);
  --shadow-lg: 0 12px 40px rgba(0,0,0,0.12);
  --radius: 20px;
  --font: 'Nunito', sans-serif;
  --font-body: 'Nunito Sans', sans-serif;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{scroll-behavior:smooth}
body{
  font-family:var(--font-body);
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  font-size:17px;
  line-height:1.7;
  overscroll-behavior:none;
}

/* â”€â”€ SPLASH â”€â”€ */
#splash{
  position:fixed;inset:0;
  background:linear-gradient(135deg,#ff6b35 0%,#ff8c42 60%,#ffa05c 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:1000;transition:opacity 0.5s;
}
#splash .splash-logo{font-family:var(--font);font-weight:900;font-size:52px;color:white;letter-spacing:-1px}
#splash .splash-logo span{color:rgba(255,255,255,0.6)}
#splash p{color:rgba(255,255,255,0.85);font-family:var(--font);font-weight:600;font-size:16px;margin-top:10px}
#splash .dot-loader{display:flex;gap:8px;margin-top:30px}
#splash .dot{width:12px;height:12px;border-radius:50%;background:rgba(255,255,255,0.7);animation:bounce 0.8s infinite alternate}
#splash .dot:nth-child(2){animation-delay:0.2s}
#splash .dot:nth-child(3){animation-delay:0.4s}
@keyframes bounce{to{transform:translateY(-10px);opacity:1}from{opacity:0.4}}

/* â”€â”€ HEADER â”€â”€ */
header{
  background:linear-gradient(135deg,var(--primary) 0%,#ff8c42 100%);
  padding:14px 20px 14px;
  padding-top:calc(14px + env(safe-area-inset-top,0px));
  display:flex;align-items:center;gap:12px;
  box-shadow:0 4px 20px rgba(255,107,53,0.3);
  position:sticky;top:0;z-index:50;
}
.logo{font-family:var(--font);font-weight:900;font-size:24px;color:white;letter-spacing:-0.5px;text-decoration:none}
.logo span{color:rgba(255,255,255,0.55)}
.header-right{margin-left:auto;display:flex;align-items:center;gap:10px}
.pts-badge{
  background:rgba(255,255,255,0.2);color:white;
  font-family:var(--font);font-weight:800;font-size:14px;
  padding:6px 14px;border-radius:50px;
  border:2px solid rgba(255,255,255,0.3);
  backdrop-filter:blur(4px);
}
.settings-btn{
  background:rgba(255,255,255,0.2);border:none;
  color:white;font-size:18px;width:36px;height:36px;
  border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;
}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;
  background:white;
  padding:8px 4px calc(8px + var(--safe-bottom));
  display:flex;justify-content:space-around;
  box-shadow:0 -4px 20px rgba(0,0,0,0.08);
  z-index:50;border-top:1px solid var(--border);
}
.nav-item{
  display:flex;flex-direction:column;align-items:center;gap:3px;
  cursor:pointer;padding:6px 10px;border-radius:14px;
  transition:all 0.2s;flex:1;max-width:72px;border:none;background:none;
}
.nav-item .ni{font-size:20px;transition:transform 0.2s}
.nav-item .nl{font-family:var(--font);font-weight:700;font-size:10px;color:var(--text-light);line-height:1.2;text-align:center}
.nav-item.active{background:var(--primary-light)}
.nav-item.active .ni{transform:scale(1.2)}
.nav-item.active .nl{color:var(--primary)}

/* â”€â”€ MAIN â”€â”€ */
main{padding:20px 16px calc(100px + var(--safe-bottom));max-width:680px;margin:0 auto}

/* â”€â”€ CARDS â”€â”€ */
.card{
  background:var(--card);border-radius:var(--radius);
  padding:24px;margin-bottom:20px;
  box-shadow:var(--shadow);
}
.card h2{
  font-family:var(--font);font-weight:900;font-size:20px;
  margin-bottom:14px;display:flex;align-items:center;gap:10px;
}
.card p{font-size:16px;line-height:1.8;margin-bottom:12px}
.card p:last-child{margin-bottom:0}

/* â”€â”€ VISUAL BLOCKS â”€â”€ */
.vb{
  border-radius:14px;padding:20px;margin:18px 0;
  border-left:5px solid;
}
.vb-orange{background:var(--primary-light);border-color:var(--primary)}
.vb-teal{background:var(--accent-light);border-color:var(--accent)}
.vb-purple{background:var(--purple-light);border-color:var(--purple)}
.vb-green{background:var(--green-light);border-color:var(--green)}
.vb-yellow{background:var(--yellow-light);border-color:var(--yellow)}
.vb-blue{background:var(--blue-light);border-color:var(--blue)}
.vb h3{font-family:var(--font);font-weight:800;font-size:16px;margin-bottom:10px}

/* â”€â”€ FORMULA BOX â”€â”€ */
.formula{
  font-family:var(--font);font-weight:900;font-size:22px;
  text-align:center;padding:16px 24px;border-radius:50px;
  margin:12px auto;display:inline-block;letter-spacing:0.5px;
}
.formula-orange{background:var(--primary);color:white}
.formula-purple{background:var(--purple);color:white}
.formula-blue{background:var(--blue);color:white}
.formula-green{background:var(--green);color:white}

/* â”€â”€ SLIDERS â”€â”€ */
.slider-row{margin:12px 0}
.slider-row label{font-family:var(--font);font-weight:700;font-size:14px;color:var(--text-light);display:block;margin-bottom:6px}
input[type=range]{
  width:100%;height:8px;-webkit-appearance:none;
  background:#e2e8f0;border-radius:4px;outline:none;cursor:pointer;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:28px;height:28px;border-radius:50%;
  background:var(--primary);border:3px solid white;
  box-shadow:0 2px 8px rgba(255,107,53,0.35);cursor:pointer;
}

/* â”€â”€ CANVAS â”€â”€ */
canvas{
  border-radius:14px;background:white;
  border:2px solid var(--border);max-width:100%;display:block;
}

/* â”€â”€ STEP PILLS â”€â”€ */
.pills{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.pill{
  padding:7px 16px;border-radius:50px;
  font-family:var(--font);font-weight:700;font-size:13px;
  background:#f1f5f9;color:var(--text-light);
  cursor:pointer;border:2px solid transparent;transition:all 0.2s;
}
.pill.active{background:var(--primary);color:white;border-color:var(--primary)}
.pill:hover:not(.active){border-color:var(--primary);color:var(--primary)}

/* â”€â”€ NUMBER LINE â”€â”€ */
.nl-scroll{overflow-x:auto;padding:16px 0}
.nl-track{
  display:flex;align-items:center;
  min-width:540px;position:relative;padding:0 10px;
}
.nl-axis{position:absolute;top:50%;left:10px;right:10px;height:3px;background:var(--text);transform:translateY(-50%)}
.nl-item{
  display:flex;flex-direction:column;align-items:center;
  flex:1;position:relative;z-index:2;cursor:pointer;
}
.nl-dot{
  width:38px;height:38px;border-radius:50%;background:white;
  border:3px solid var(--text);display:flex;align-items:center;justify-content:center;
  font-family:var(--font);font-weight:800;font-size:14px;
  transition:all 0.2s;margin-bottom:6px;
}
.nl-item.neg .nl-dot{border-color:var(--red);color:var(--red)}
.nl-item.zero .nl-dot{border-color:var(--text);background:var(--text);color:white;width:44px;height:44px}
.nl-item.pos .nl-dot{border-color:var(--green);color:var(--green)}
.nl-item:hover .nl-dot{transform:scale(1.25);box-shadow:0 0 0 5px rgba(0,0,0,0.08)}
.nl-lbl{font-size:10px;font-family:var(--font);font-weight:700;color:var(--text-light)}

/* â”€â”€ FRACTION VIS â”€â”€ */
.frac-parts{display:flex;flex-wrap:wrap;gap:5px;margin:14px 0}
.fp{
  width:46px;height:46px;border-radius:10px;
  border:2px solid var(--border);background:#f8fafc;
  transition:all 0.3s;cursor:default;
}
.fp.on{background:var(--primary);border-color:var(--primary)}

/* â”€â”€ EXERCISE ZONE â”€â”€ */
.ex-zone{
  background:linear-gradient(135deg,#f8fafc,#f0f4ff);
  border-radius:var(--radius);padding:24px;
  margin-top:4px;border:2px solid var(--border);
}
.ex-zone h3{
  font-family:var(--font);font-weight:900;font-size:17px;
  color:var(--purple);margin-bottom:16px;
  display:flex;align-items:center;gap:8px;
}
.q-card{background:white;border-radius:16px;padding:22px;box-shadow:0 2px 12px rgba(0,0,0,0.05)}
.q-num{
  font-family:var(--font);font-weight:800;font-size:11px;
  color:white;background:var(--purple);padding:3px 10px;
  border-radius:50px;display:inline-block;margin-bottom:12px;
  letter-spacing:0.5px;
}
.q-text{
  font-family:var(--font);font-weight:700;font-size:18px;
  color:var(--text);margin-bottom:20px;line-height:1.5;
}
/* Visual question support */
.q-visual{
  background:var(--blue-light);border-radius:12px;padding:14px;
  margin-bottom:16px;font-family:var(--font);font-weight:700;
  font-size:15px;color:var(--blue);line-height:1.7;
  border-left:4px solid var(--blue);
}
.opts{
  display:grid;grid-template-columns:repeat(2,1fr);gap:10px;
}
.opts.four-opts{grid-template-columns:repeat(2,1fr)}
.opt-btn{
  padding:18px 10px;border-radius:14px;border:3px solid var(--border);
  background:white;cursor:pointer;
  font-family:var(--font);font-weight:800;font-size:18px;
  color:var(--text);transition:all 0.2s;text-align:center;line-height:1.3;
  -webkit-user-select:none;user-select:none;
}
.opt-btn:active{transform:scale(0.96)}
.opt-btn:hover:not(.locked){border-color:var(--primary);background:var(--primary-light);transform:scale(1.03)}
.opt-btn.correct{background:var(--green-light)!important;border-color:var(--green)!important;color:var(--green)!important;animation:pop 0.35s ease}
.opt-btn.wrong{background:#fef2f2!important;border-color:var(--red)!important;color:var(--red)!important;animation:shake 0.35s ease}
.opt-btn.locked{cursor:default}
@keyframes pop{0%{transform:scale(1)}40%{transform:scale(1.12)}100%{transform:scale(1)}}
@keyframes shake{0%{transform:translateX(0)}20%{transform:translateX(-8px)}60%{transform:translateX(8px)}100%{transform:translateX(0)}}

.feedback{
  margin-top:14px;padding:14px 18px;border-radius:12px;
  font-family:var(--font);font-weight:800;font-size:15px;
  display:none;align-items:flex-start;gap:10px;line-height:1.5;
}
.feedback.show{display:flex}
.feedback.ok{background:var(--green-light);color:#15803d}
.feedback.ko{background:#fef2f2;color:#b91c1c}

/* â”€â”€ HINT â”€â”€ */
.hint-btn{
  display:inline-flex;align-items:center;gap:6px;
  background:none;border:2px solid var(--yellow);
  border-radius:50px;padding:7px 16px;
  cursor:pointer;font-family:var(--font);font-weight:700;
  font-size:13px;color:#92400e;margin-top:14px;
  transition:all 0.2s;
}
.hint-btn:hover{background:var(--yellow-light)}
.hint-box{
  display:none;margin-top:10px;padding:14px 16px;
  background:var(--yellow-light);border:2px dashed var(--yellow);
  border-radius:12px;font-family:var(--font);font-weight:600;
  font-size:14px;color:#92400e;line-height:1.6;
}
.hint-box.show{display:block}

/* â”€â”€ NEXT BTN â”€â”€ */
.next-btn{
  display:inline-flex;align-items:center;gap:8px;
  background:linear-gradient(135deg,var(--primary),#ff8c42);
  color:white;border:none;border-radius:50px;
  padding:14px 28px;font-family:var(--font);font-weight:800;
  font-size:16px;cursor:pointer;margin-top:18px;
  box-shadow:0 4px 16px rgba(255,107,53,0.35);
  transition:all 0.2s;
}
.next-btn:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(255,107,53,0.5)}

/* â”€â”€ PROGRESS â”€â”€ */
.q-progress{
  display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;
}
.q-dot{
  width:28px;height:28px;border-radius:50%;
  background:var(--border);font-family:var(--font);
  font-weight:800;font-size:11px;display:flex;align-items:center;
  justify-content:center;color:white;transition:all 0.3s;
}
.q-dot.done-ok{background:var(--green)}
.q-dot.done-ko{background:var(--red)}
.q-dot.current{background:var(--primary);transform:scale(1.15)}

/* â”€â”€ TOOLS FLOATING â”€â”€ */
.tools-row{
  display:flex;flex-wrap:wrap;gap:8px;
  padding:12px 16px;background:var(--card);
  border-bottom:1px solid var(--border);
  position:sticky;top:58px;z-index:40;
  overflow-x:auto;
  padding-top:calc(12px + env(safe-area-inset-top,0px) * 0);
}
.tool-chip{
  display:inline-flex;align-items:center;gap:5px;
  padding:8px 14px;border-radius:50px;
  background:var(--accent-light);border:2px solid var(--accent);
  font-family:var(--font);font-weight:700;font-size:13px;
  color:#0f766e;cursor:pointer;white-space:nowrap;
  transition:all 0.2s;flex-shrink:0;
}
.tool-chip:hover{background:var(--accent);color:white;transform:scale(1.04)}

/* â”€â”€ MODAL â”€â”€ */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.55);
  z-index:200;display:none;align-items:flex-end;justify-content:center;
  padding:0;backdrop-filter:blur(6px);
}
.overlay.show{display:flex}
.modal{
  background:white;border-radius:28px 28px 0 0;
  padding:28px 24px calc(24px + var(--safe-bottom));
  width:100%;max-width:560px;
  box-shadow:0 -8px 40px rgba(0,0,0,0.18);
  animation:slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1);
  max-height:88vh;overflow-y:auto;
}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:40px;height:4px;background:#ddd;border-radius:2px;margin:0 auto 20px}
.modal h3{font-family:var(--font);font-weight:900;font-size:20px;margin-bottom:18px}
.modal-close{
  width:100%;margin-top:20px;padding:14px;
  background:var(--primary);color:white;border:none;border-radius:14px;
  font-family:var(--font);font-weight:800;font-size:16px;cursor:pointer;
  transition:all 0.2s;
}
.modal-close:hover{background:var(--primary-dark)}

/* â”€â”€ CALCULATOR â”€â”€ */
.calc{background:#1e293b;border-radius:20px;padding:18px;max-width:300px;margin:0 auto}
.calc-disp{
  background:#0f172a;border-radius:12px;padding:14px 18px;
  text-align:right;font-family:var(--font);font-weight:800;
  font-size:30px;color:#f8fafc;margin-bottom:14px;min-height:58px;
  word-break:break-all;
}
.calc-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.cb{
  padding:16px 8px;border-radius:12px;border:none;
  font-family:var(--font);font-weight:800;font-size:18px;
  cursor:pointer;transition:all 0.15s;background:#334155;color:#f8fafc;
}
.cb:active{transform:scale(0.93)}
.cb.op{background:var(--primary);color:white}
.cb.eq{background:var(--accent);color:white;grid-column:span 2}
.cb.clr{background:var(--red);color:white}
.cb.z{grid-column:span 2}

/* â”€â”€ PITA TABLE â”€â”€ */
.pt{border-collapse:collapse;width:100%;font-family:var(--font);font-weight:700;font-size:13px;border-radius:12px;overflow:hidden}
.pt th{background:var(--purple);color:white;padding:8px 5px;text-align:center}
.pt td{padding:7px 4px;text-align:center;border:1px solid #f1f5f9;cursor:pointer;transition:background 0.15s}
.pt td:hover{background:var(--purple-light)}
.pt tr:nth-child(even) td{background:#fafafa}
.pt tr:nth-child(even) td:hover{background:var(--purple-light)}
.pt td.diag{background:var(--purple-light);color:var(--purple);font-weight:900}

/* â”€â”€ FORMULE SHEET â”€â”€ */
.form-row{
  display:flex;align-items:center;gap:12px;
  padding:12px 0;border-bottom:1px solid var(--border);
  font-family:var(--font);
}
.form-row:last-child{border-bottom:none}
.form-icon{font-size:26px;flex-shrink:0;width:36px;text-align:center}
.form-content .name{font-weight:800;font-size:14px;color:var(--text-light)}
.form-content .f{font-weight:800;font-size:16px;color:var(--text);margin-top:2px}
.form-content .inv{font-size:13px;color:var(--purple);font-weight:700;margin-top:2px}

/* â”€â”€ STATS PAGE â”€â”€ */
.stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:20px}
.stat-box{
  background:white;border-radius:16px;padding:18px;
  box-shadow:var(--shadow);text-align:center;
}
.stat-box .sv{font-family:var(--font);font-weight:900;font-size:34px}
.stat-box .sl{font-family:var(--font);font-weight:700;font-size:12px;color:var(--text-light);margin-top:4px}
.stars-row{display:flex;gap:4px;justify-content:center;font-size:26px;margin:6px 0}

/* â”€â”€ ACCESS BAR â”€â”€ */
.access-bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:16px}
.ac-btn{
  padding:8px 16px;border-radius:50px;border:2px solid var(--border);
  background:white;cursor:pointer;font-family:var(--font);font-weight:700;
  font-size:13px;color:var(--text-light);transition:all 0.2s;
  display:flex;align-items:center;gap:5px;
}
.ac-btn.on{background:var(--primary);border-color:var(--primary);color:white}
.ac-btn:hover{transform:scale(1.04)}

/* â”€â”€ ACCESSIBILITY MODES â”€â”€ */
body.large-text{font-size:20px}
body.large-text .opt-btn{font-size:22px;padding:22px 10px}
body.large-text .q-text{font-size:22px}
body.large-text .formula{font-size:26px}
body.high-contrast{
  --bg:#0a0a0a;--card:#1a1a1a;--text:#ffffff;--text-light:#aaaaaa;
  --border:#333;--primary-light:#2a1200;--accent-light:#001a18;
  --purple-light:#180033;--green-light:#001a0d;--yellow-light:#1a1500;
  --blue-light:#001226;
}
body.high-contrast .opt-btn{background:#1a1a1a!important;color:white!important}
body.dsa-font *{letter-spacing:0.08em!important;word-spacing:0.15em!important;line-height:2.1!important}

/* â”€â”€ PROGRESS BAR â”€â”€ */
.prog-bar-wrap{height:6px;background:var(--border);border-radius:3px;margin-bottom:16px;overflow:hidden}
.prog-bar-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--yellow));border-radius:3px;transition:width 0.5s ease}

/* â”€â”€ CONTENT PAGES â”€â”€ */
.page{display:none}
.page.active{display:block}

/* â”€â”€ HOME PAGE â”€â”€ */
.home-hero{
  background:linear-gradient(135deg,var(--primary) 0%,#ff8c42 50%,#ffa05c 100%);
  border-radius:var(--radius);padding:28px 24px;margin-bottom:20px;
  color:white;position:relative;overflow:hidden;
}
.home-hero::after{
  content:'ğŸ§ ';font-size:80px;
  position:absolute;right:-10px;bottom:-10px;opacity:0.25;
  transform:rotate(15deg);
}
.home-hero h1{font-family:var(--font);font-weight:900;font-size:26px;margin-bottom:8px}
.home-hero p{font-size:15px;opacity:0.9;line-height:1.6;max-width:300px}
.topic-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
.topic-card{
  background:var(--card);border-radius:18px;padding:20px;
  box-shadow:var(--shadow);cursor:pointer;border:3px solid transparent;
  transition:all 0.25s;display:flex;flex-direction:column;gap:8px;
}
.topic-card:hover,.topic-card:active{transform:translateY(-3px);box-shadow:var(--shadow-lg)}
.topic-card .tc-icon{font-size:32px}
.topic-card .tc-name{font-family:var(--font);font-weight:800;font-size:14px;line-height:1.3}
.topic-card .tc-count{font-size:12px;color:var(--text-light);font-family:var(--font);font-weight:600}
.topic-card .tc-bar{height:4px;border-radius:2px;background:var(--border);margin-top:4px}
.topic-card .tc-fill{height:100%;border-radius:2px;transition:width 0.5s}

/* â”€â”€ AUTHOR â”€â”€ */
.author-tag{
  text-align:center;padding:16px;
  font-family:var(--font);font-size:13px;font-weight:600;
  color:var(--text-light);
}
.author-tag strong{color:var(--primary)}

/* â”€â”€ INSTALL BANNER â”€â”€ */
#install-banner{
  display:none;position:fixed;bottom:calc(70px + var(--safe-bottom));
  left:16px;right:16px;
  background:linear-gradient(135deg,var(--purple),#7c3aed);
  color:white;border-radius:18px;padding:16px 20px;
  box-shadow:0 8px 32px rgba(139,92,246,0.4);
  z-index:60;animation:slideUp 0.4s ease;
}
#install-banner.show{display:flex;align-items:center;gap:12px}
#install-banner p{flex:1;font-family:var(--font);font-weight:700;font-size:14px;line-height:1.4}
.install-btn{
  background:white;color:var(--purple);border:none;border-radius:50px;
  padding:10px 18px;font-family:var(--font);font-weight:800;font-size:13px;
  cursor:pointer;white-space:nowrap;flex-shrink:0;
}
.install-x{background:none;border:none;color:rgba(255,255,255,0.6);font-size:20px;cursor:pointer;flex-shrink:0;padding:0 4px}

/* â”€â”€ SECTION HEADER â”€â”€ */
.sec-header{
  display:flex;align-items:center;gap:12px;margin-bottom:20px;
}
.sec-back{
  background:none;border:2px solid var(--border);border-radius:50%;
  width:40px;height:40px;cursor:pointer;font-size:18px;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.2s;color:var(--text);flex-shrink:0;
}
.sec-back:hover{background:var(--primary-light);border-color:var(--primary);color:var(--primary)}
.sec-header h2{font-family:var(--font);font-weight:900;font-size:22px}

/* geom visual helpers */
.geom-result{
  font-family:var(--font);font-weight:800;font-size:20px;
  text-align:center;margin-top:14px;padding:14px;
  background:var(--purple-light);border-radius:12px;color:var(--purple);
}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="splash-logo">Math<span>Up</span> ğŸš€</div>
  <p>Matematica 2Âª Media â€“ DSA Friendly</p>
  <div class="dot-loader">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>
</div>

<!-- HEADER -->
<header id="mainHeader">
  <span class="logo">Math<span>Up</span></span>
  <div class="header-right">
    <span class="pts-badge" id="ptsBadge">â­ 0 pt</span>
    <button class="settings-btn" onclick="showPage('settings')" title="Impostazioni">âš™ï¸</button>
  </div>
</header>

<!-- TOOLS ROW -->
<div class="tools-row" id="toolsRow">
  <button class="tool-chip" onclick="openModal('mCalc')">ğŸ”¢ Calcolatrice</button>
  <button class="tool-chip" onclick="openModal('mPita')">âœ–ï¸ Tav. Pitagorica</button>
  <button class="tool-chip" onclick="openModal('mForm')">ğŸ“ Formule</button>
  <button class="tool-chip" onclick="openModal('mReg')">Â± Regole Segni</button>
</div>

<!-- MAIN -->
<main id="mainContent">

  <!-- â•â•â•â•â•â•â•â•â•â•â• HOME â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="page active" id="pageHome">
    <div class="home-hero">
      <h1>Ciao! Pronto a fare matematica? ğŸ¯</h1>
      <p>Scegli un argomento. Nessuno scrive a mano â€” si risponde sempre cliccando!</p>
    </div>
    <div class="topic-grid">
      <div class="topic-card" onclick="showTopic('numeri')" style="border-color:#ef444422" id="tc-numeri">
        <div class="tc-icon">Â±</div>
        <div class="tc-name">Numeri Relativi</div>
        <div class="tc-count" id="cnt-numeri">10 esercizi</div>
        <div class="tc-bar"><div class="tc-fill" id="fill-numeri" style="width:0%;background:#ef4444"></div></div>
      </div>
      <div class="topic-card" onclick="showTopic('frazioni')" style="border-color:#f59e0b22" id="tc-frazioni">
        <div class="tc-icon">Â½</div>
        <div class="tc-name">Frazioni</div>
        <div class="tc-count" id="cnt-frazioni">10 esercizi</div>
        <div class="tc-bar"><div class="tc-fill" id="fill-frazioni" style="width:0%;background:#f59e0b"></div></div>
      </div>
      <div class="topic-card" onclick="showTopic('geometria')" style="border-color:#3b82f622" id="tc-geometria">
        <div class="tc-icon">ğŸ”·</div>
        <div class="tc-name">Geometria & Aree</div>
        <div class="tc-count" id="cnt-geometria">15 esercizi</div>
        <div class="tc-bar"><div class="tc-fill" id="fill-geometria" style="width:0%;background:#3b82f6"></div></div>
      </div>
      <div class="topic-card" onclick="showTopic('pitagora')" style="border-color:#8b5cf622" id="tc-pitagora">
        <div class="tc-icon">ğŸ“</div>
        <div class="tc-name">Teorema di Pitagora</div>
        <div class="tc-count" id="cnt-pitagora">10 esercizi</div>
        <div class="tc-bar"><div class="tc-fill" id="fill-pitagora" style="width:0%;background:#8b5cf6"></div></div>
      </div>
      <div class="topic-card" onclick="showTopic('algebra')" style="border-color:#22c55e22" id="tc-algebra">
        <div class="tc-icon">ğŸ”¤</div>
        <div class="tc-name">Algebra</div>
        <div class="tc-count" id="cnt-algebra">10 esercizi</div>
        <div class="tc-bar"><div class="tc-fill" id="fill-algebra" style="width:0%;background:#22c55e"></div></div>
      </div>
      <div class="topic-card" onclick="showTopic('statistica')" style="border-color:#f59e0b22" id="tc-statistica">
        <div class="tc-icon">ğŸ“Š</div>
        <div class="tc-name">Statistica</div>
        <div class="tc-count" id="cnt-statistica">10 esercizi</div>
        <div class="tc-bar"><div class="tc-fill" id="fill-statistica" style="width:0%;background:#f59e0b"></div></div>
      </div>
    </div>
    <div class="author-tag">Creato da <strong>Valerio Spiga</strong> Â· MathUp v1.0 Â· DSA Friendly ğŸ§¡</div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• TOPIC PAGE â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="page" id="pageTopicLesson">
    <div class="sec-header">
      <button class="sec-back" onclick="showPage('home')" aria-label="Torna alla home">â†</button>
      <h2 id="topicTitle"></h2>
    </div>
    <div id="lessonContent"></div>
    <div class="ex-zone" id="exZone">
      <h3 id="exTitle">ğŸ’ª Esercitati â€” clicca la risposta!</h3>
      <div class="q-progress" id="qProgress"></div>
      <div class="prog-bar-wrap"><div class="prog-bar-fill" id="qProgBar" style="width:0%"></div></div>
      <div id="quizArea"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• STATS â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="page" id="pageStats">
    <div class="sec-header" style="margin-bottom:20px">
      <h2>ğŸ“Š I tuoi progressi</h2>
    </div>
    <div class="stat-grid" id="statGrid"></div>
    <div class="card" id="statDetail"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• SETTINGS â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="page" id="pageSettings">
    <div class="sec-header" style="margin-bottom:20px">
      <button class="sec-back" onclick="showPage('home')">â†</button>
      <h2>âš™ï¸ Impostazioni</h2>
    </div>
    <div class="card">
      <h2>â™¿ AccessibilitÃ </h2>
      <div class="access-bar">
        <button class="ac-btn" id="btnLarge" onclick="toggleA('large-text',this)">ğŸ”¤ Testo Grande</button>
        <button class="ac-btn" id="btnContrast" onclick="toggleA('high-contrast',this)">ğŸŒ™ Alto Contrasto</button>
        <button class="ac-btn" id="btnDSA" onclick="toggleA('dsa-font',this)">ğŸ“– Font DSA</button>
        <button class="ac-btn" id="btnSound" onclick="toggleSound(this)">ğŸ”Š Audio Attivo</button>
      </div>
    </div>
    <div class="card">
      <h2>â„¹ï¸ Informazioni</h2>
      <p><strong>MathUp</strong> Ã¨ una webapp educativa pensata per studenti di 2Âª media con discalculia e disgrafia, ispirata alle linee guida pedagogiche per i DSA (Legge 170/2010).</p>
      <p>Principi adottati: piccoli passi progressivi, risposta per clic (nessuna scrittura), strumenti compensativi sempre visibili, feedback immediato, rinforzo positivo.</p>
      <p style="margin-top:16px;font-family:var(--font);font-weight:800;color:var(--primary)">Autore: Valerio Spiga</p>
      <p style="font-size:14px;color:var(--text-light)">Versione 1.0 Â· 2025</p>
    </div>
    <div class="card">
      <h2>ğŸ“² Installazione su telefono</h2>
      <p><strong>iPhone / iPad (Safari):</strong> tocca il pulsante Condividi â†‘ â†’ "Aggiungi alla schermata Home"</p>
      <p><strong>Android (Chrome):</strong> tocca i tre puntini â‹® â†’ "Aggiungi alla schermata Home" oppure "Installa app"</p>
    </div>
    <div class="author-tag">Made with ğŸ§¡ by <strong>Valerio Spiga</strong></div>
  </div>

</main>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-item active" id="nav-home" onclick="showPage('home')" aria-label="Home">
    <span class="ni">ğŸ </span><span class="nl">Home</span>
  </button>
  <button class="nav-item" id="nav-geo" onclick="showTopic('geometria')" aria-label="Geometria">
    <span class="ni">ğŸ”·</span><span class="nl">Geometria</span>
  </button>
  <button class="nav-item" id="nav-stats" onclick="showPage('stats')" aria-label="Progressi">
    <span class="ni">ğŸ“Š</span><span class="nl">Progressi</span>
  </button>
  <button class="nav-item" id="nav-set" onclick="showPage('settings')" aria-label="Impostazioni">
    <span class="ni">âš™ï¸</span><span class="nl">Imposta</span>
  </button>
</nav>

<!-- INSTALL BANNER -->
<div id="install-banner">
  <p>ğŸ“² Installa MathUp sul tuo telefono!</p>
  <button class="install-btn" id="installBtn">Installa</button>
  <button class="install-x" onclick="document.getElementById('install-banner').classList.remove('show')">âœ•</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="mCalc" onclick="if(event.target===this)closeModal('mCalc')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>ğŸ”¢ Calcolatrice</h3>
    <div class="calc">
      <div class="calc-disp" id="calcDisp">0</div>
      <div class="calc-grid">
        <button class="cb clr" onclick="ci('C')">C</button>
        <button class="cb op" onclick="ci('Â±')">Â±</button>
        <button class="cb op" onclick="ci('%')">%</button>
        <button class="cb op" onclick="ci('Ã·')">Ã·</button>
        <button class="cb" onclick="ci('7')">7</button><button class="cb" onclick="ci('8')">8</button>
        <button class="cb" onclick="ci('9')">9</button><button class="cb op" onclick="ci('Ã—')">Ã—</button>
        <button class="cb" onclick="ci('4')">4</button><button class="cb" onclick="ci('5')">5</button>
        <button class="cb" onclick="ci('6')">6</button><button class="cb op" onclick="ci('âˆ’')">âˆ’</button>
        <button class="cb" onclick="ci('1')">1</button><button class="cb" onclick="ci('2')">2</button>
        <button class="cb" onclick="ci('3')">3</button><button class="cb op" onclick="ci('+')">+</button>
        <button class="cb z" onclick="ci('0')">0</button>
        <button class="cb" onclick="ci('.')">.</button>
        <button class="cb eq" onclick="ci('=')">=</button>
      </div>
    </div>
    <button class="modal-close" onclick="closeModal('mCalc')">âœ“ Chiudi</button>
  </div>
</div>

<div class="overlay" id="mPita" onclick="if(event.target===this)closeModal('mPita')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>âœ–ï¸ Tavola Pitagorica</h3>
    <div style="overflow-x:auto"><table class="pt" id="pitaTable"></table></div>
    <button class="modal-close" onclick="closeModal('mPita')">âœ“ Chiudi</button>
  </div>
</div>

<div class="overlay" id="mForm" onclick="if(event.target===this)closeModal('mForm')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>ğŸ“ Formule & Inverse</h3>
    <div id="formuleList"></div>
    <button class="modal-close" onclick="closeModal('mForm')">âœ“ Chiudi</button>
  </div>
</div>

<div class="overlay" id="mReg" onclick="if(event.target===this)closeModal('mReg')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>Â± Regole dei Segni</h3>
    <div style="font-family:var(--font);font-weight:700;font-size:17px;line-height:2.6">
      <p>â• Ã— â• = <strong style="color:var(--green)">POSITIVO</strong></p>
      <p>â– Ã— â– = <strong style="color:var(--green)">POSITIVO</strong></p>
      <p>â• Ã— â– = <strong style="color:var(--red)">NEGATIVO</strong></p>
      <p>â– Ã— â• = <strong style="color:var(--red)">NEGATIVO</strong></p>
      <hr style="margin:8px 0;opacity:0.15">
      <p style="font-size:14px;color:var(--text-light)">Segni <strong>uguali</strong> â†’ risultato <strong style="color:var(--green)">+</strong></p>
      <p style="font-size:14px;color:var(--text-light)">Segni <strong>diversi</strong> â†’ risultato <strong style="color:var(--red)">âˆ’</strong></p>
    </div>
    <button class="modal-close" onclick="closeModal('mReg')">âœ“ Chiudi</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const state = {
  points: 0,
  sound: false,
  topic: null,
  quizIdx: 0,
  quizAnswered: false,
  progress: { numeri:{done:0,correct:0}, frazioni:{done:0,correct:0}, geometria:{done:0,correct:0}, pitagora:{done:0,correct:0}, algebra:{done:0,correct:0}, statistica:{done:0,correct:0} }
};
let installPrompt = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const QUIZZES = {

numeri: [
  { q:'Quale numero Ã¨ piÃ¹ grande?', opts:['âˆ’3','0','+2','âˆ’10'], ans:'+2', hint:'Sulla retta, piÃ¹ stai a destra = piÃ¹ grande.' },
  { q:'Ordina dal piÃ¹ piccolo: +2, âˆ’5, 0, âˆ’1', opts:['âˆ’5 < âˆ’1 < 0 < +2','0 < âˆ’1 < âˆ’5 < +2','âˆ’1 < âˆ’5 < 0 < +2','+2 < 0 < âˆ’1 < âˆ’5'], ans:'âˆ’5 < âˆ’1 < 0 < +2', hint:'I negativi piÃ¹ lontani da zero sono i piÃ¹ piccoli.' },
  { q:'Quanto fa (+5) + (âˆ’3)?', opts:['8','2','âˆ’2','+15'], ans:'2', hint:'Parti da +5, fai 3 passi a sinistra sulla retta.' },
  { q:'Quanto fa (âˆ’4) + (âˆ’2)?', opts:['âˆ’6','6','âˆ’2','2'], ans:'âˆ’6', hint:'Due negativi si sommano: 4+2=6, poi metti il segno âˆ’.' },
  { q:'Quanto fa (âˆ’4) Ã— (âˆ’2)?', opts:['âˆ’8','8','âˆ’6','6'], ans:'8', hint:'Segni uguali â†’ risultato positivo. 4Ã—2=8.' },
  { q:'Quanto fa (+6) Ã— (âˆ’3)?', opts:['âˆ’18','18','âˆ’9','9'], ans:'âˆ’18', hint:'Segni diversi â†’ risultato negativo. 6Ã—3=18.' },
  { q:'Quanto fa (âˆ’12) Ã· (+4)?', opts:['âˆ’3','3','âˆ’8','8'], ans:'âˆ’3', hint:'Segni diversi â†’ negativo. 12Ã·4=3.' },
  { q:'Quale affermazione Ã¨ VERA?', opts:['âˆ’7 > âˆ’3','âˆ’1 < 0','0 < âˆ’5','+2 < âˆ’4'], ans:'âˆ’1 < 0', hint:'Zero Ã¨ piÃ¹ grande di qualsiasi numero negativo.' },
  { q:'Quanto fa (+3) âˆ’ (âˆ’5)?', opts:['âˆ’2','2','8','âˆ’8'], ans:'8', hint:'Sottrarre un negativo = sommare il positivo: 3+5=8.' },
  { q:'La temperatura era âˆ’3Â°C e Ã¨ scesa di 4Â°C. Ora Ã¨:', opts:['âˆ’7Â°C','+1Â°C','âˆ’1Â°C','+7Â°C'], ans:'âˆ’7Â°C', hint:'âˆ’3 + (âˆ’4) = âˆ’7. Scendere = sommare un negativo.' },
],

frazioni: [
  { q:'Qual Ã¨ la forma ridotta di 4/8?', opts:['1/2','2/4','3/6','4/8'], ans:'1/2', hint:'Dividi sia numeratore che denominatore per 4.' },
  { q:'Quale frazione Ã¨ la piÃ¹ grande?', opts:['1/4','1/3','1/5','1/6'], ans:'1/3', hint:'Stesso numeratore: il denominatore piÃ¹ piccolo dÃ  la frazione piÃ¹ grande.' },
  { q:'Quanto fa 1/2 + 1/4?', opts:['2/6','3/4','2/8','1/3'], ans:'3/4', hint:'Riduci allo stesso denominatore: 2/4 + 1/4 = 3/4.' },
  { q:'Quanto fa 3/5 Ã— 2/3?', opts:['6/15','5/8','2/5','3/8'], ans:'2/5', hint:'Moltiplica: (3Ã—2)/(5Ã—3) = 6/15 = 2/5.' },
  { q:'Quanto fa 3/4 âˆ’ 1/2?', opts:['2/2','1/4','1/2','2/4'], ans:'1/4', hint:'1/2 = 2/4. Poi 3/4 âˆ’ 2/4 = 1/4.' },
  { q:'Qual Ã¨ il reciproco di 3/5?', opts:['3/5','5/3','1/5','6/10'], ans:'5/3', hint:'Capovolgi la frazione: numeratore e denominatore si scambiano.' },
  { q:'Quanto fa 2/3 Ã· 4/9?', opts:['8/27','3/2','1/2','9/6'], ans:'3/2', hint:'Dividi = moltiplica per il reciproco: 2/3 Ã— 9/4 = 18/12 = 3/2.' },
  { q:'Quale frazione Ã¨ equivalente a 6/9?', opts:['3/4','2/3','1/3','4/6'], ans:'2/3', hint:'Semplifica dividendo per 3: 6Ã·3=2, 9Ã·3=3.' },
  { q:'Un quarto di 20 Ã¨:', opts:['10','4','5','8'], ans:'5', hint:'1/4 Ã— 20 = 20Ã·4 = 5.' },
  { q:'Tre ottavi (3/8) scritti come percentuale Ã¨ circa:', opts:['37,5%','38%','30%','25%'], ans:'37,5%', hint:'3Ã·8 = 0,375 â†’ moltiplica per 100.' },
],

geometria: [
  // FORMULE DIRETTE
  { q:'Rettangolo: base=6 cm, altezza=4 cm. Qual Ã¨ l\'area?', opts:['24 cmÂ²','20 cmÂ²','10 cmÂ²','16 cmÂ²'], ans:'24 cmÂ²', hint:'A = base Ã— altezza = 6 Ã— 4', vis:'â–­ b=6, h=4' },
  { q:'Triangolo: base=8 cm, altezza=5 cm. Qual Ã¨ l\'area?', opts:['40 cmÂ²','13 cmÂ²','20 cmÂ²','80 cmÂ²'], ans:'20 cmÂ²', hint:'A = (base Ã— altezza) Ã· 2 = (8Ã—5)Ã·2', vis:'â–³ b=8, h=5' },
  { q:'Trapezio: B=10, b=6, h=4. Qual Ã¨ l\'area?', opts:['40 cmÂ²','32 cmÂ²','60 cmÂ²','24 cmÂ²'], ans:'32 cmÂ²', hint:'A = (B+b)/2 Ã— h = (10+6)/2 Ã— 4 = 8Ã—4', vis:'âŒ‚ B=10, b=6, h=4' },
  { q:'Parallelogramma: base=7 cm, altezza=3 cm. Area?', opts:['21 cmÂ²','10 cmÂ²','42 cmÂ²','14 cmÂ²'], ans:'21 cmÂ²', hint:'A = base Ã— altezza = 7 Ã— 3', vis:'â¬§ b=7, h=3' },
  { q:'Quadrato con lato=5 cm. Qual Ã¨ l\'area?', opts:['20 cmÂ²','10 cmÂ²','25 cmÂ²','15 cmÂ²'], ans:'25 cmÂ²', hint:'A = latoÂ² = 5Â² = 25', vis:'â–  l=5' },
  // FORMULE INVERSE â€” trovare un lato
  { q:'ğŸ“ FORMULA INVERSA: Un rettangolo ha area=30 cmÂ² e altezza=5 cm. Quanto Ã¨ la base?', opts:['6 cm','25 cm','150 cm','3 cm'], ans:'6 cm', hint:'Base = Area Ã· altezza = 30 Ã· 5', vis:'Area=30, h=5 â†’ b=?' },
  { q:'ğŸ“ FORMULA INVERSA: Un triangolo ha area=18 cmÂ² e altezza=6 cm. Quanto Ã¨ la base?', opts:['3 cm','6 cm','108 cm','12 cm'], ans:'6 cm', hint:'b = (2 Ã— Area) Ã· h = (2Ã—18)Ã·6 = 36Ã·6', vis:'Area=18, h=6 â†’ b=?' },
  { q:'ğŸ“ FORMULA INVERSA: Un parallelogramma ha area=42 cmÂ² e base=7 cm. Quanto Ã¨ l\'altezza?', opts:['6 cm','49 cm','294 cm','5 cm'], ans:'6 cm', hint:'h = Area Ã· base = 42 Ã· 7', vis:'Area=42, b=7 â†’ h=?' },
  { q:'ğŸ“ FORMULA INVERSA: Un quadrato ha area=64 cmÂ². Quanto Ã¨ il lato?', opts:['8 cm','16 cm','32 cm','4 cm'], ans:'8 cm', hint:'lato = âˆšArea = âˆš64 = 8. Usa la tavola delle radici!', vis:'Area=64 â†’ l=?' },
  { q:'ğŸ“ FORMULA INVERSA: Un trapezio ha area=20 cmÂ², h=4 cm, base minore b=3. Quanto Ã¨ la base maggiore B?', opts:['7 cm','5 cm','10 cm','17 cm'], ans:'7 cm', hint:'A=(B+b)/2Ã—h â†’ B = (2Ã—A/h) âˆ’ b = (2Ã—20/4)âˆ’3 = 10âˆ’3', vis:'Area=20, h=4, b=3 â†’ B=?' },
  // PERIMETRI
  { q:'Rettangolo: b=7 cm, h=3 cm. Qual Ã¨ il perimetro?', opts:['20 cm','21 cm','10 cm','40 cm'], ans:'20 cm', hint:'P = 2Ã—(b+h) = 2Ã—(7+3) = 2Ã—10 = 20', vis:'â–­ perimetro' },
  { q:'Quadrato con lato=6 cm. Perimetro?', opts:['24 cm','12 cm','36 cm','18 cm'], ans:'24 cm', hint:'P = 4 Ã— lato = 4Ã—6 = 24', vis:'â–  perimetro' },
  // FORMULA INVERSA PERIMETRO
  { q:'ğŸ“ INVERSA: Un rettangolo ha perimetro=24 cm e base=8 cm. Quanto Ã¨ l\'altezza?', opts:['4 cm','16 cm','3 cm','12 cm'], ans:'4 cm', hint:'P=2(b+h) â†’ h = P/2 âˆ’ b = 12âˆ’8 = 4', vis:'P=24, b=8 â†’ h=?' },
  { q:'ğŸ“ INVERSA: Un quadrato ha perimetro=36 cm. Quanto Ã¨ il lato?', opts:['9 cm','12 cm','4 cm','18 cm'], ans:'9 cm', hint:'P = 4Ã—l â†’ l = PÃ·4 = 36Ã·4', vis:'P=36 â†’ l=?' },
  { q:'Se raddoppio la base di un rettangolo (altezza invariata), l\'area:', opts:['rimane uguale','si raddoppia','si dimezza','si quadruplica'], ans:'si raddoppia', hint:'A=bÃ—h. Se bâ†’2b, allora Aâ†’2bÃ—h = 2Ã—(bÃ—h).', vis:'' },
],

pitagora: [
  { q:'Cateti 3 e 4. Ipotenusa?', opts:['5','7','6','4,5'], ans:'5', hint:'3Â²+4Â²=9+16=25. âˆš25=5! Ãˆ la terna pitagorica piÃ¹ famosa.' },
  { q:'Cateti 6 e 8. Ipotenusa?', opts:['14','10','9','12'], ans:'10', hint:'36+64=100. âˆš100=10.' },
  { q:'Cateti 5 e 12. Ipotenusa?', opts:['17','13','15','11'], ans:'13', hint:'25+144=169. âˆš169=13.' },
  { q:'Cateti 8 e 15. Ipotenusa?', opts:['17','21','23','19'], ans:'17', hint:'64+225=289. âˆš289=17.' },
  // INVERSE â€” trovare un cateto
  { q:'ğŸ“ INVERSA: Ipotenusa=10, un cateto=6. Quanto Ã¨ l\'altro cateto?', opts:['4','8','6','âˆš136'], ans:'8', hint:'b=âˆš(cÂ²âˆ’aÂ²)=âˆš(100âˆ’36)=âˆš64=8.' },
  { q:'ğŸ“ INVERSA: Ipotenusa=13, un cateto=5. Quanto Ã¨ l\'altro cateto?', opts:['8','10','12','9'], ans:'12', hint:'b=âˆš(169âˆ’25)=âˆš144=12.' },
  { q:'ğŸ“ INVERSA: Ipotenusa=17, un cateto=8. Quanto Ã¨ l\'altro cateto?', opts:['9','15','12','10'], ans:'15', hint:'b=âˆš(289âˆ’64)=âˆš225=15.' },
  { q:'L\'ipotenusa Ã¨...', opts:['il lato piÃ¹ corto','qualsiasi lato','il lato opposto all\'angolo retto','adiacente all\'angolo retto'], ans:'il lato opposto all\'angolo retto', hint:'L\'ipotenusa Ã¨ sempre di fronte al 90Â°.' },
  { q:'Un triangolo con lati 3, 4, 6 Ã¨ rettangolo?', opts:['SÃ¬','No â€” non vale aÂ²+bÂ²=cÂ²','Non si puÃ² dire','Solo se l\'angolo Ã¨ 45Â°'], ans:'No â€” non vale aÂ²+bÂ²=cÂ²', hint:'3Â²+4Â²=25. 6Â²=36. 25â‰ 36, quindi NON Ã¨ rettangolo.' },
  { q:'Un quadrato con diagonale=10 cm: quanto Ã¨ il lato? (lÂ²+lÂ²=100)', opts:['5 cm','âˆš50 â‰ˆ 7,07 cm','âˆš200 cm','10 cm'], ans:'âˆš50 â‰ˆ 7,07 cm', hint:'2lÂ²=100 â†’ lÂ²=50 â†’ l=âˆš50â‰ˆ7,07.' },
],

algebra: [
  { q:'Se x + 4 = 9, quanto vale x?', opts:['5','13','4','6'], ans:'5', hint:'Togli 4 da entrambe le parti: x = 9 âˆ’ 4.' },
  { q:'Quanto vale 3x se x = 4?', opts:['7','34','12','1'], ans:'12', hint:'3x = 3 Ã— 4 = 12.' },
  { q:'Se 2x = 10, quanto vale x?', opts:['5','20','8','12'], ans:'5', hint:'Dividi entrambe le parti per 2: x = 10Ã·2.' },
  { q:'Se x âˆ’ 3 = 7, quanto vale x?', opts:['4','10','21','âˆ’4'], ans:'10', hint:'Aggiungi 3 a entrambe le parti: x = 7+3.' },
  { q:'Quale espressione Ã¨ un MONOMIO?', opts:['x+2','3xÂ²','x+y','2xâˆ’1'], ans:'3xÂ²', hint:'Un monomio Ã¨ un singolo termine senza somme o differenze.' },
  { q:'Quanto vale 2x + 3 se x = 5?', opts:['10','13','16','8'], ans:'13', hint:'Sostituisci: 2Ã—5+3 = 10+3 = 13.' },
  { q:'Se 3x + 1 = 10, quanto vale x?', opts:['3','9','11','4'], ans:'3', hint:'Prima togli 1: 3x=9. Poi dividi per 3: x=3.' },
  { q:'Somma dei monomi 2x e 5x:', opts:['10xÂ²','7x','7xÂ²','3x'], ans:'7x', hint:'Somma i coefficienti (2+5=7) e tieni la stessa lettera.' },
  { q:'Quanto vale âˆ’2x se x = âˆ’3?', opts:['âˆ’6','6','+2','âˆ’1'], ans:'6', hint:'âˆ’2 Ã— (âˆ’3) = +6. Segni uguali â†’ positivo.' },
  { q:'Se x/4 = 3, quanto vale x?', opts:['0,75','7','12','1'], ans:'12', hint:'Moltiplica entrambe le parti per 4: x = 3Ã—4 = 12.' },
],

statistica: [
  { q:'Media di: 4, 6, 8, 2', opts:['5','6','4','7'], ans:'5', hint:'Somma=20. Media=20Ã·4=5.' },
  { q:'Media di: 10, 6, 8, 4, 2', opts:['5','6','4','7'], ans:'6', hint:'Somma=30. Media=30Ã·5=6.' },
  { q:'Moda di: 3, 5, 3, 7, 5, 3', opts:['5','7','3','6'], ans:'3', hint:'3 compare 3 volte â€” Ã¨ il dato piÃ¹ frequente.' },
  { q:'Mediana di: 2, 4, 6, 8, 10', opts:['4','6','5','8'], ans:'6', hint:'5 elementi: il terzo Ã¨ il centrale â†’ 6.' },
  { q:'Mediana di: 3, 5, 7, 9 (4 elementi)', opts:['6','5','7','4'], ans:'6', hint:'Con 4 elementi: media dei due centrali = (5+7)/2 = 6.' },
  { q:'Moda di: 1, 2, 2, 3, 3, 3, 4', opts:['1','2','3','4'], ans:'3', hint:'3 compare 3 volte, piÃ¹ di tutti.' },
  { q:'Media di: 0, 0, 6, 0', opts:['6','2','1,5','3'], ans:'1,5', hint:'Somma=6. Media=6Ã·4=1,5. Anche gli zeri contano!' },
  { q:'Ordina per trovare la mediana di: 5, 1, 9, 3, 7', opts:['5','3','1','7'], ans:'5', hint:'Ordinati: 1,3,5,7,9. Il valore di mezzo (3Â°) Ã¨ 5.' },
  { q:'Se aggiungessi il dato 100 a {2,3,4,5,6}, la MEDIAâ€¦', opts:['non cambia','sale molto','scende','rimane circa uguale'], ans:'sale molto', hint:'100 Ã¨ molto piÃ¹ grande degli altri, alza la media di molto.' },
  { q:'La MEDIANA Ã¨ piÃ¹ "robusta" della media perchÃ©:', opts:['Ã¨ sempre piÃ¹ grande','non Ã¨ influenzata dai valori estremi','Ã¨ piÃ¹ facile da calcolare','Ã¨ uguale alla moda'], ans:'non Ã¨ influenzata dai valori estremi', hint:'Anche se c\'Ã¨ un dato abnorme, la mediana non cambia tanto.' },
],

};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LESSONS HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LESSONS = {
numeri: `
<div class="card">
  <h2 style="color:#ef4444">Â± I Numeri Relativi</h2>
  <p>I numeri relativi hanno un <strong>segno</strong>: positivi (+) o negativi (âˆ’). Pensa alla <strong>temperatura</strong> o ai <strong>piani di un palazzo</strong>: il âˆ’2 Ã¨ il secondo piano interrato!</p>
  <div class="vb vb-orange">
    <h3>ğŸŒ¡ï¸ Tocca i numeri sulla retta:</h3>
    <div class="nl-scroll"><div class="nl-track" id="numLine"><div class="nl-axis"></div></div></div>
  </div>
  <div class="vb vb-teal">
    <h3>ğŸ“Œ Ordine sulla retta</h3>
    <p>PiÃ¹ andiamo a <strong>destra</strong> â†’ numero piÃ¹ grande<br>
    PiÃ¹ andiamo a <strong>sinistra</strong> â†’ numero piÃ¹ piccolo<br><br>
    âˆ’5 &lt; âˆ’3 &lt; âˆ’1 &lt; 0 &lt; +1 &lt; +3 &lt; +5</p>
  </div>
  <div class="vb vb-green">
    <h3>â• Regola della somma</h3>
    <p>Stessi segni â†’ somma i valori, tieni il segno<br>
    Segni diversi â†’ sottrai il minore dal maggiore, prendi il segno del piÃ¹ grande</p>
  </div>
</div>`,

frazioni: `
<div class="card">
  <h2 style="color:#f59e0b">Â½ Le Frazioni</h2>
  <p>Una frazione Ã¨ una <strong>parte di un intero</strong>. Il numero sotto si chiama <strong>denominatore</strong> (quante parti), quello sopra <strong>numeratore</strong> (quante ne prendiamo).</p>
  <div class="vb vb-yellow">
    <h3>ğŸ• Muovi i cursori:</h3>
    <div class="slider-row"><label>Numeratore (parti colorate): <strong id="fNum">3</strong></label>
      <input type="range" min="1" max="8" value="3" id="fSlNum" oninput="updateFrac()"></div>
    <div class="slider-row"><label>Denominatore (parti totali): <strong id="fDen">4</strong></label>
      <input type="range" min="2" max="8" value="4" id="fSlDen" oninput="updateFrac()"></div>
    <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;margin-top:8px">
      <div class="frac-parts" id="fracParts"></div>
      <div style="font-family:var(--font);font-weight:900;font-size:32px;color:var(--primary);text-align:center;min-width:80px">
        <div id="fDispN">3</div><div style="border-top:3px solid var(--primary);margin:4px 0"></div><div id="fDispD">4</div>
        <div style="font-size:14px;color:var(--text-light);margin-top:6px" id="fPct"></div>
      </div>
    </div>
  </div>
</div>`,

geometria: `
<div class="card">
  <h2 style="color:#3b82f6">ğŸ”· Geometria: Aree & Formule Inverse</h2>
  <p>L'area misura quanto <em>spazio occupa</em> una figura. Si misura in <strong>cmÂ², mÂ²</strong>â€¦</p>
  <div class="pills" id="geomPills">
    <div class="pill active" onclick="showGeomShape(this,'rect')">â–­ Rettangolo</div>
    <div class="pill" onclick="showGeomShape(this,'tri')">â–³ Triangolo</div>
    <div class="pill" onclick="showGeomShape(this,'para')">â¬§ Parallelogramma</div>
    <div class="pill" onclick="showGeomShape(this,'trap')">âŒ‚ Trapezio</div>
    <div class="pill" onclick="showGeomShape(this,'sq')">â–  Quadrato</div>
  </div>
  <div id="geomShape"></div>
  <div class="vb vb-purple" style="margin-top:16px">
    <h3>ğŸ” Come si usa la formula inversa?</h3>
    <p>Se conosco l'area ma non un lato, <strong>isolo</strong> il valore cercato:<br>
    A = bÃ—h &nbsp;â†’&nbsp; <strong>b = AÃ·h</strong> &nbsp;oppure&nbsp; <strong>h = AÃ·b</strong></p>
  </div>
</div>`,

pitagora: `
<div class="card">
  <h2 style="color:#8b5cf6">ğŸ“ Il Teorema di Pitagora</h2>
  <p>In un triangolo <strong>rettangolo</strong>: la somma dei quadrati dei due cateti = il quadrato dell'ipotenusa.</p>
  <div style="text-align:center;margin:16px 0">
    <span class="formula formula-purple">aÂ² + bÂ² = cÂ²</span>
    <p style="font-size:14px;color:var(--text-light);margin-top:8px">c = ipotenusa (lato piÃ¹ lungo, di fronte a 90Â°)</p>
  </div>
  <div class="vb vb-purple">
    <h3>ğŸ® Muovi i cursori â€” il triangolo si ridisegna!</h3>
    <div style="display:flex;gap:14px;flex-wrap:wrap">
      <div class="slider-row" style="flex:1;min-width:120px">
        <label>Cateto a: <strong id="pA">3</strong></label>
        <input type="range" min="1" max="9" value="3" id="slPA" oninput="drawPita()">
      </div>
      <div class="slider-row" style="flex:1;min-width:120px">
        <label>Cateto b: <strong id="pB">4</strong></label>
        <input type="range" min="1" max="9" value="4" id="slPB" oninput="drawPita()">
      </div>
    </div>
    <div style="display:flex;justify-content:center;margin-top:10px">
      <canvas id="pitaCanvas" width="320" height="260"></canvas>
    </div>
    <div class="geom-result" id="pitaResult"></div>
  </div>
  <div class="vb vb-blue">
    <h3>ğŸ” Formula inversa (trovare un cateto)</h3>
    <p>Se conosco c e un cateto a:<br>
    <strong>b = âˆš(cÂ² âˆ’ aÂ²)</strong></p>
  </div>
</div>`,

algebra: `
<div class="card">
  <h2 style="color:#22c55e">ğŸ”¤ Algebra: Lettere e Equazioni</h2>
  <p>In algebra le <strong>lettere sostituiscono numeri sconosciuti</strong>. Ãˆ come un gioco dove <strong>x</strong> Ã¨ la risposta da trovare!</p>
  <div class="vb vb-green">
    <h3>ğŸ La scatola misteriosa</h3>
    <p>ğŸ“¦ + 3 = 7 &nbsp;â†’&nbsp; quante palline nella scatola?<br>
    Con le lettere: &nbsp;<strong>x + 3 = 7 â†’ x = 4</strong></p>
  </div>
  <div class="vb vb-teal">
    <h3>âš–ï¸ Regola d'oro</h3>
    <p>Quello che fai a <strong>sinistra</strong> dell'uguale lo fai anche a <strong>destra</strong>.</p>
    <p style="margin-top:8px">Esempio: &nbsp;x + 5 = 12<br>
    â†’ tolgo 5 da entrambe le parti<br>
    â†’ x = 12 âˆ’ 5 = <strong>7</strong> âœ…</p>
  </div>
  <div class="vb vb-orange">
    <h3>ğŸ“š Tipi di espressioni</h3>
    <p>ğŸ”¹ <strong>Monomio</strong>: un solo termine â†’ 3xÂ², âˆ’5y, 2ab<br>
    ğŸ”¹ <strong>Polinomio</strong>: piÃ¹ monomi sommati â†’ 3x + 2y âˆ’ 1</p>
  </div>
</div>`,

statistica: `
<div class="card">
  <h2 style="color:#f59e0b">ğŸ“Š Statistica: Media, Moda, Mediana</h2>
  <p>La statistica ci aiuta a <strong>descrivere e capire i dati</strong>. I tre indicatori principali si chiamano <em>indici di posizione centrale</em>.</p>
  <div class="vb vb-yellow">
    <h3>ğŸ“Š Esempio: voti della settimana</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin:10px 0" id="votiRow"></div>
    <div id="statCalc" style="font-family:var(--font);font-weight:700;font-size:15px;line-height:2.2;margin-top:10px"></div>
  </div>
  <div class="vb vb-teal">
    <h3>ğŸ“Œ Differenza chiave</h3>
    <p>ğŸ”¹ <strong>Media</strong>: Ã¨ influenzata dai valori estremi<br>
    ğŸ”¹ <strong>Mediana</strong>: Ã¨ "robusta" (non cambia con i valori anomali)<br>
    ğŸ”¹ <strong>Moda</strong>: il valore che "vince" per frequenza</p>
  </div>
</div>`,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGE NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(p) {
  document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  const pages = { home:'pageHome', stats:'pageStats', settings:'pageSettings' };
  const navs  = { home:'nav-home', stats:'nav-stats', settings:'nav-set' };
  if(pages[p]) document.getElementById(pages[p]).classList.add('active');
  if(navs[p]) document.getElementById(navs[p]).classList.add('active');
  if(p==='stats') renderStats();
  window.scrollTo(0,0);
}

function showTopic(name) {
  document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  document.getElementById('pageTopicLesson').classList.add('active');
  if(name==='geometria') document.getElementById('nav-geo').classList.add('active');

  const titles = {
    numeri:'Â± Numeri Relativi',
    frazioni:'Â½ Frazioni',
    geometria:'ğŸ”· Geometria & Aree',
    pitagora:'ğŸ“ Teorema di Pitagora',
    algebra:'ğŸ”¤ Algebra',
    statistica:'ğŸ“Š Statistica',
  };
  document.getElementById('topicTitle').textContent = titles[name]||name;
  document.getElementById('lessonContent').innerHTML = LESSONS[name]||'';
  state.topic = name;
  state.quizIdx = 0;
  state.quizAnswered = false;

  // Init lesson interactives
  if(name==='numeri') setTimeout(initNumLine,100);
  if(name==='frazioni') setTimeout(()=>{updateFrac();},100);
  if(name==='geometria') setTimeout(()=>showGeomShape(document.querySelector('#geomPills .pill'),'rect'),100);
  if(name==='pitagora') setTimeout(drawPita,100);
  if(name==='statistica') setTimeout(initStat,100);

  renderQuiz(name);
  window.scrollTo(0,0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderQuiz(topic) {
  const data = QUIZZES[topic];
  const idx = state.quizIdx;
  const q = data[idx];
  const total = data.length;

  // Progress dots
  const prog = document.getElementById('qProgress');
  prog.innerHTML = data.map((_,i)=>{
    let cls = 'q-dot';
    const p = state.progress[topic];
    if(i<idx) cls+=' done-ok'; // simplification
    if(i===idx) cls+=' current';
    return `<div class="${cls}">${i+1}</div>`;
  }).join('');

  document.getElementById('qProgBar').style.width = (idx/total*100)+'%';

  const area = document.getElementById('quizArea');
  const qTitle = document.getElementById('exTitle');
  qTitle.textContent = `ğŸ’ª Esercizio ${idx+1} di ${total}`;

  const visHtml = q.vis ? `<div class="q-visual">ğŸ“Š ${q.vis}</div>` : '';

  area.innerHTML = `
    <div class="q-card">
      <div class="q-num">DOMANDA ${idx+1} / ${total}</div>
      ${visHtml}
      <div class="q-text">${q.q}</div>
      <div class="opts four-opts" id="optsGrid">
        ${q.opts.map(o=>`<button class="opt-btn" onclick="checkAns(this,'${o.replace(/'/g,"\\'")}','${q.ans.replace(/'/g,"\\'")}','${topic}')">${o}</button>`).join('')}
      </div>
      <button class="hint-btn" onclick="toggleHint()">ğŸ’¡ Suggerimento</button>
      <div class="hint-box" id="hintBox">${q.hint}</div>
      <div class="feedback" id="fbBox"></div>
    </div>`;
}

function checkAns(btn, chosen, correct, topic) {
  if(state.quizAnswered) return;
  state.quizAnswered = true;
  const fb = document.getElementById('fbBox');
  const grid = document.getElementById('optsGrid');

  // lock all
  grid.querySelectorAll('.opt-btn').forEach(b=>b.classList.add('locked'));

  if(chosen===correct) {
    btn.classList.add('correct');
    fb.innerHTML = 'ğŸ‰ Bravo! Risposta corretta!';
    fb.className = 'feedback show ok';
    playCorrect();
    addPoints(10);
    state.progress[topic].correct++;
  } else {
    btn.classList.add('wrong');
    grid.querySelectorAll('.opt-btn').forEach(b=>{ if(b.textContent===correct) b.classList.add('correct'); });
    fb.innerHTML = `âŒ Non Ã¨ quella. La risposta giusta era: <strong>${correct}</strong>`;
    fb.className = 'feedback show ko';
    playWrong();
  }
  state.progress[topic].done++;

  // Next
  const data = QUIZZES[topic];
  const nextBtn = document.createElement('button');
  nextBtn.className = 'next-btn';
  nextBtn.innerHTML = state.quizIdx >= data.length-1 ? 'ğŸ† Ricomincia da capo' : 'Prossima domanda â†’';
  nextBtn.onclick = () => {
    state.quizIdx = (state.quizIdx+1) % data.length;
    state.quizAnswered = false;
    renderQuiz(topic);
    saveProgress();
    updateHome();
  };
  document.querySelector('.q-card').appendChild(nextBtn);
}

function toggleHint() {
  document.getElementById('hintBox').classList.toggle('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LESSON INTERACTIVES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Number line
function initNumLine() {
  const nl = document.getElementById('numLine');
  if(!nl) return;
  nl.innerHTML = '<div class="nl-axis"></div>';
  for(let i=-5;i<=5;i++){
    const it = document.createElement('div');
    it.className = 'nl-item ' + (i<0?'neg':i===0?'zero':'pos');
    const lbl = i>0?'+'+i:String(i);
    it.innerHTML = `<div class="nl-dot">${lbl}</div><div class="nl-lbl">${i<0?'neg':i===0?'zero':'pos'}</div>`;
    it.onclick=()=>{ speak(lbl); it.querySelector('.nl-dot').style.transform='scale(1.4)'; setTimeout(()=>it.querySelector('.nl-dot').style.transform='',400); };
    nl.appendChild(it);
  }
}

// Fraction
function updateFrac() {
  const ns = document.getElementById('fSlNum');
  const ds = document.getElementById('fSlDen');
  if(!ns||!ds) return;
  const den = parseInt(ds.value);
  ns.max = den;
  const num = Math.min(parseInt(ns.value), den);
  ns.value = num;
  document.getElementById('fNum').textContent = num;
  document.getElementById('fDen').textContent = den;
  document.getElementById('fDispN').textContent = num;
  document.getElementById('fDispD').textContent = den;
  document.getElementById('fPct').textContent = Math.round(num/den*100)+'%';
  const parts = document.getElementById('fracParts');
  parts.innerHTML = '';
  for(let i=0;i<den;i++){
    const p=document.createElement('div');
    p.className='fp'+(i<num?' on':'');
    parts.appendChild(p);
  }
}

// Geometry shape display
const GEOM_SHAPES = {
  rect:{ name:'Rettangolo', formula:'A = base Ã— altezza', inv:'base = A Ã· h &nbsp;|&nbsp; h = A Ã· base', color:'#3b82f6', vars:['base','altezza'],
    calc:(a,b)=>a*b,
    draw:(ctx,a,b,sc)=>{
      ctx.fillStyle='rgba(59,130,246,0.12)'; ctx.fillRect(40,40,a*sc,b*sc);
      ctx.strokeStyle='#3b82f6'; ctx.lineWidth=3; ctx.strokeRect(40,40,a*sc,b*sc);
      ctx.fillStyle='#3b82f6'; ctx.font='bold 15px Nunito,sans-serif'; ctx.textAlign='center';
      ctx.fillText('b='+a, 40+a*sc/2, 40+b*sc+22);
      ctx.textAlign='right'; ctx.fillText('h='+b, 36, 40+b*sc/2+6);
    }},
  tri:{ name:'Triangolo', formula:'A = (base Ã— altezza) Ã· 2', inv:'base = (2Ã—A) Ã· h &nbsp;|&nbsp; h = (2Ã—A) Ã· base', color:'#ef4444', vars:['base','altezza'],
    calc:(a,b)=>a*b/2,
    draw:(ctx,a,b,sc)=>{
      ctx.beginPath(); ctx.moveTo(40+a*sc/2,30); ctx.lineTo(40,30+b*sc); ctx.lineTo(40+a*sc,30+b*sc); ctx.closePath();
      ctx.fillStyle='rgba(239,68,68,0.12)'; ctx.fill();
      ctx.strokeStyle='#ef4444'; ctx.lineWidth=3; ctx.stroke();
      ctx.setLineDash([5,4]); ctx.strokeStyle='#aaa'; ctx.beginPath();
      ctx.moveTo(40+a*sc/2,30); ctx.lineTo(40+a*sc/2,30+b*sc); ctx.stroke(); ctx.setLineDash([]);
    }},
  para:{ name:'Parallelogramma', formula:'A = base Ã— altezza', inv:'base = A Ã· h &nbsp;|&nbsp; h = A Ã· base', color:'#8b5cf6', vars:['base','altezza'],
    calc:(a,b)=>a*b,
    draw:(ctx,a,b,sc)=>{
      const off=25;
      ctx.beginPath(); ctx.moveTo(40+off,30); ctx.lineTo(40+off+a*sc,30); ctx.lineTo(40+a*sc,30+b*sc); ctx.lineTo(40,30+b*sc); ctx.closePath();
      ctx.fillStyle='rgba(139,92,246,0.12)'; ctx.fill();
      ctx.strokeStyle='#8b5cf6'; ctx.lineWidth=3; ctx.stroke();
    }},
  trap:{ name:'Trapezio', formula:'A = (B + b) Ã— h Ã· 2', inv:'B = (2Ã—A Ã· h) âˆ’ b', color:'#22c55e', vars:['base magg. (B)','altezza'],
    calc:(B,h)=>(B+Math.round(B*0.6))*h/2,
    draw:(ctx,B,h,sc)=>{
      const b=Math.round(B*0.6), off=(B-b)*sc/2;
      ctx.beginPath(); ctx.moveTo(40+off,30); ctx.lineTo(40+off+b*sc,30); ctx.lineTo(40+B*sc,30+h*sc); ctx.lineTo(40,30+h*sc); ctx.closePath();
      ctx.fillStyle='rgba(34,197,94,0.12)'; ctx.fill();
      ctx.strokeStyle='#22c55e'; ctx.lineWidth=3; ctx.stroke();
      ctx.fillStyle='#22c55e'; ctx.font='bold 13px Nunito,sans-serif'; ctx.textAlign='center';
      ctx.fillText('B='+B, 40+B*sc/2, 30+h*sc+22);
      ctx.fillText('bâ‰ˆ'+b, 40+off+b*sc/2, 22);
    }},
  sq:{ name:'Quadrato', formula:'A = latoÂ²', inv:'lato = âˆšA', color:'#f59e0b', vars:['lato','lato'],
    calc:(a)=>a*a,
    draw:(ctx,a,_,sc)=>{
      ctx.fillStyle='rgba(245,158,11,0.12)'; ctx.fillRect(40,40,a*sc,a*sc);
      ctx.strokeStyle='#f59e0b'; ctx.lineWidth=3; ctx.strokeRect(40,40,a*sc,a*sc);
      ctx.fillStyle='#f59e0b'; ctx.font='bold 15px Nunito,sans-serif'; ctx.textAlign='center';
      ctx.fillText('l='+a, 40+a*sc/2, 40+a*sc+22);
    }},
};
let gState = {key:'rect', v1:5, v2:4};
function showGeomShape(pillEl, key) {
  document.querySelectorAll('#geomPills .pill').forEach(p=>p.classList.remove('active'));
  if(pillEl) pillEl.classList.add('active');
  gState.key=key;
  const s=GEOM_SHAPES[key];
  const html = `
    <div class="vb vb-blue">
      <h3>${s.name}</h3>
      <div style="text-align:center;margin:10px 0"><span class="formula formula-blue" style="font-size:16px;padding:10px 20px">${s.formula}</span></div>
      <div style="font-size:13px;color:var(--purple);font-family:var(--font);font-weight:700;margin-bottom:14px;text-align:center">ğŸ” Inversa: ${s.inv}</div>
      <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">
        <canvas id="geomCanvas" width="280" height="200" style="flex-shrink:0;max-width:100%"></canvas>
        <div style="flex:1;min-width:130px">
          <div class="slider-row"><label>${s.vars[0]}: <strong id="gv1">${gState.v1}</strong></label>
            <input type="range" min="2" max="8" value="${gState.v1}" oninput="gState.v1=+this.value;document.getElementById('gv1').textContent=this.value;drawGeom()" style="accent-color:${s.color}">
          </div>
          ${key!=='sq'?`<div class="slider-row"><label>${s.vars[1]}: <strong id="gv2">${gState.v2}</strong></label>
            <input type="range" min="2" max="8" value="${gState.v2}" oninput="gState.v2=+this.value;document.getElementById('gv2').textContent=this.value;drawGeom()" style="accent-color:${s.color}"></div>`:''}
          <div class="geom-result" id="geomResult">A = â€¦</div>
        </div>
      </div>
    </div>`;
  document.getElementById('geomShape').innerHTML=html;
  setTimeout(drawGeom,50);
}
function drawGeom() {
  const s=GEOM_SHAPES[gState.key];
  const c=document.getElementById('geomCanvas');
  if(!c) return;
  const ctx=c.getContext('2d');
  ctx.clearRect(0,0,280,200);
  s.draw(ctx, gState.v1, gState.v2, 26);
  const area = s.calc(gState.v1, gState.v2);
  document.getElementById('geomResult').innerHTML = `Area = ${area.toFixed(1)} cmÂ²`;
}

// Pitagora canvas
function drawPita() {
  const a=parseInt(document.getElementById('slPA')?.value||3);
  const b=parseInt(document.getElementById('slPB')?.value||4);
  document.getElementById('pA').textContent=a;
  document.getElementById('pB').textContent=b;
  const c=Math.sqrt(a*a+b*b);
  const canvas=document.getElementById('pitaCanvas');
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const W=320,H=260,pad=50,sc=24;
  ctx.clearRect(0,0,W,H);
  const ox=pad, oy=H-pad, px=ox+a*sc, py=oy, qx=ox, qy=oy-b*sc;
  ctx.beginPath(); ctx.moveTo(ox,oy); ctx.lineTo(px,py); ctx.lineTo(qx,qy); ctx.closePath();
  ctx.fillStyle='rgba(139,92,246,0.1)'; ctx.fill();
  [[ox,oy,px,py,'#ef4444',`a=${a}`,(ox+px)/2,oy+20],
   [ox,oy,qx,qy,'#3b82f6',`b=${b}`,ox-22,(oy+qy)/2],
   [px,py,qx,qy,'#8b5cf6',`câ‰ˆ${c.toFixed(2)}`,(px+qx)/2+18,(py+qy)/2-8]
  ].forEach(([x1,y1,x2,y2,col,lbl,tx,ty])=>{
    ctx.strokeStyle=col; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    ctx.fillStyle=col; ctx.font='bold 15px Nunito,sans-serif'; ctx.textAlign='center'; ctx.fillText(lbl,tx,ty);
  });
  const sq=12; ctx.strokeStyle='#888'; ctx.lineWidth=1.5; ctx.strokeRect(ox,oy-sq,sq,sq);
  document.getElementById('pitaResult').innerHTML = `${a}Â² + ${b}Â² = ${a*a} + ${b*b} = <strong>${a*a+b*b}</strong> â†’ c = âˆš${a*a+b*b} â‰ˆ <strong>${c.toFixed(2)}</strong>`;
}

// Statistics
function initStat() {
  const voti=[6,7,8,6,9,7,6,8];
  const row=document.getElementById('votiRow');
  if(!row) return;
  row.innerHTML=voti.map(v=>`<div style="width:46px;height:46px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:var(--font);font-weight:900;font-size:20px;background:var(--yellow-light);border:3px solid var(--yellow);color:#92400e">${v}</div>`).join('');
  const media=(voti.reduce((a,b)=>a+b,0)/voti.length).toFixed(2);
  const sorted=[...voti].sort((a,b)=>a-b);
  const med=(sorted[3]+sorted[4])/2;
  const freq={}; voti.forEach(v=>freq[v]=(freq[v]||0)+1);
  const moda=Object.entries(freq).sort((a,b)=>b[1]-a[1])[0][0];
  document.getElementById('statCalc').innerHTML=
    `ğŸ“ <strong>Media</strong> = (${voti.join('+')})/8 = ${voti.reduce((a,b)=>a+b,0)}/8 = <span style="color:var(--primary)">${media}</span><br>
     ğŸ” <strong>Moda</strong> = valore piÃ¹ frequente = <span style="color:var(--accent)">${moda}</span> (appare ${freq[moda]} volte)<br>
     ğŸ“ <strong>Mediana</strong> = ordinati: [${sorted.join(',')}] â†’ media dei due centrali = <span style="color:var(--purple)">${med}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats() {
  const topics = [
    {key:'numeri',name:'Numeri Relativi',icon:'Â±',color:'#ef4444'},
    {key:'frazioni',name:'Frazioni',icon:'Â½',color:'#f59e0b'},
    {key:'geometria',name:'Geometria',icon:'ğŸ”·',color:'#3b82f6'},
    {key:'pitagora',name:'Pitagora',icon:'ğŸ“',color:'#8b5cf6'},
    {key:'algebra',name:'Algebra',icon:'ğŸ”¤',color:'#22c55e'},
    {key:'statistica',name:'Statistica',icon:'ğŸ“Š',color:'#f59e0b'},
  ];
  const totalPts = state.points;
  const stars = Math.min(5, Math.floor(totalPts/60));
  document.getElementById('statGrid').innerHTML = `
    <div class="stat-box" style="grid-column:span 2">
      <div class="sv" style="color:var(--primary)">${totalPts}</div>
      <div class="sl">PUNTI TOTALI</div>
      <div class="stars-row">${'â­'.repeat(stars)}${'â˜†'.repeat(5-stars)}</div>
    </div>
    ${topics.map(t=>{
      const p=state.progress[t.key];
      const pct = p.done>0 ? Math.round(p.correct/p.done*100) : 0;
      return `<div class="stat-box">
        <div style="font-size:26px">${t.icon}</div>
        <div class="sv" style="color:${t.color}">${pct}%</div>
        <div class="sl">${t.name}</div>
        <div style="font-size:11px;color:var(--text-light);margin-top:4px">${p.done} risposte</div>
      </div>`;
    }).join('')}
  `;
  document.getElementById('statDetail').innerHTML = `
    <h2>ğŸ† Il tuo percorso</h2>
    <p style="margin-top:10px">Risposte totali: <strong>${Object.values(state.progress).reduce((a,p)=>a+p.done,0)}</strong></p>
    <p>Risposte corrette: <strong style="color:var(--green)">${Object.values(state.progress).reduce((a,p)=>a+p.correct,0)}</strong></p>
    <p style="font-size:14px;color:var(--text-light);margin-top:12px">Continua ad esercitarti â€” ogni errore Ã¨ un passo verso la comprensione! ğŸ§¡</p>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POINTS & HOME UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addPoints(n) {
  state.points += n;
  document.getElementById('ptsBadge').textContent = `â­ ${state.points} pt`;
}
function updateHome() {
  const tots = {numeri:10,frazioni:10,geometria:15,pitagora:10,algebra:10,statistica:10};
  Object.keys(tots).forEach(k=>{
    const p=state.progress[k];
    const fill=document.getElementById('fill-'+k);
    if(fill) fill.style.width = Math.min(100, p.done/tots[k]*100)+'%';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCESSIBILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleA(cls, btn) {
  document.body.classList.toggle(cls);
  btn.classList.toggle('on');
}
let soundOn=false;
function toggleSound(btn) {
  soundOn=!soundOn;
  btn.classList.toggle('on', soundOn);
  btn.textContent = soundOn?'ğŸ”Š Audio Attivo':'ğŸ”‡ Audio OFF';
}
function speak(t) {
  if(!soundOn) return;
  try{ const u=new SpeechSynthesisUtterance(t);u.lang='it-IT';u.rate=0.9;speechSynthesis.speak(u); }catch(e){}
}
function playCorrect() {
  if(!soundOn) return;
  try{ const ctx=new AudioContext(),o=ctx.createOscillator(),g=ctx.createGain();
    o.connect(g);g.connect(ctx.destination);o.frequency.value=660;o.type='sine';
    g.gain.setValueAtTime(0.3,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.3);
    o.start();o.stop(ctx.currentTime+0.3);
    setTimeout(()=>{ const o2=ctx.createOscillator(),g2=ctx.createGain();o2.connect(g2);g2.connect(ctx.destination);
      o2.frequency.value=880;g2.gain.setValueAtTime(0.25,ctx.currentTime);g2.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.25);
      o2.start();o2.stop(ctx.currentTime+0.25); },150);
  }catch(e){}
}
function playWrong() {
  if(!soundOn) return;
  try{ const ctx=new AudioContext(),o=ctx.createOscillator(),g=ctx.createGain();
    o.connect(g);g.connect(ctx.destination);o.frequency.value=220;o.type='sawtooth';
    g.gain.setValueAtTime(0.2,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.4);
    o.start();o.stop(ctx.currentTime+0.4);
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cExpr='', cPrevRes=false;
function ci(v) {
  const d=document.getElementById('calcDisp');
  if(v==='C'){cExpr='';d.textContent='0';return;}
  if(v==='='){
    try{
      const e=cExpr.replace(/Ã—/g,'*').replace(/Ã·/g,'/').replace(/âˆ’/g,'-');
      const r=Function('"use strict";return('+e+')')();
      d.textContent=parseFloat(r.toFixed(8));
      cExpr=String(parseFloat(r.toFixed(8)));
      cPrevRes=true;
    }catch(e){d.textContent='Err';cExpr='';}
    return;
  }
  if(v==='Â±'){cExpr=cExpr?String(-parseFloat(cExpr)):cExpr;d.textContent=cExpr||'0';return;}
  if(v==='%'){cExpr=cExpr?String(parseFloat(cExpr)/100):cExpr;d.textContent=cExpr||'0';return;}
  if(cPrevRes&&'0123456789'.includes(v)){cExpr='';cPrevRes=false;}
  cExpr+=v; d.textContent=cExpr;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PITAGORA TABLE BUILD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const t=document.getElementById('pitaTable');
  let h='<tr><th>Ã—</th>';
  for(let i=1;i<=10;i++) h+=`<th>${i}</th>`;
  h+='</tr>';
  for(let r=1;r<=10;r++){
    h+=`<tr><th>${r}</th>`;
    for(let c=1;c<=10;c++) h+=`<td class="${r===c?'diag':''}">${r*c}</td>`;
    h+='</tr>';
  }
  t.innerHTML=h;
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMULE SHEET BUILD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const defs=[
    {icon:'â–­',name:'Rettangolo',f:'A = b Ã— h',inv:'b = AÃ·h &nbsp; h = AÃ·b &nbsp; P = 2(b+h)'},
    {icon:'â– ',name:'Quadrato',f:'A = lÂ²',inv:'l = âˆšA &nbsp; P = 4l'},
    {icon:'â–³',name:'Triangolo',f:'A = (b Ã— h) Ã· 2',inv:'b = 2AÃ·h &nbsp; h = 2AÃ·b'},
    {icon:'â¬§',name:'Parallelogramma',f:'A = b Ã— h',inv:'b = AÃ·h &nbsp; h = AÃ·b'},
    {icon:'âŒ‚',name:'Trapezio',f:'A = (B+b) Ã— h Ã· 2',inv:'B = (2AÃ·h) âˆ’ b'},
    {icon:'â­•',name:'Cerchio',f:'A = Ï€ Ã— rÂ²',inv:'r = âˆš(AÃ·Ï€) &nbsp; C = 2Ï€r'},
    {icon:'ğŸ“',name:'Pitagora',f:'aÂ² + bÂ² = cÂ²',inv:'b = âˆš(cÂ²âˆ’aÂ²)'},
  ];
  document.getElementById('formuleList').innerHTML=defs.map(d=>`
    <div class="form-row">
      <div class="form-icon">${d.icon}</div>
      <div class="form-content">
        <div class="name">${d.name}</div>
        <div class="f">${d.f}</div>
        <div class="inv">â†© ${d.inv}</div>
      </div>
    </div>`).join('');
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){document.getElementById(id).classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE / LOAD PROGRESS (localStorage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveProgress() {
  try{ localStorage.setItem('mathup_progress', JSON.stringify({pts:state.points, prog:state.progress})); }catch(e){}
}
function loadProgress() {
  try{
    const d=JSON.parse(localStorage.getItem('mathup_progress'));
    if(d){ state.points=d.pts||0; Object.assign(state.progress,d.prog||{}); }
  }catch(e){}
  document.getElementById('ptsBadge').textContent=`â­ ${state.points} pt`;
  updateHome();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA INSTALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  installPrompt = e;
  document.getElementById('install-banner').classList.add('show');
});
document.getElementById('installBtn').onclick = async () => {
  if(!installPrompt) return;
  installPrompt.prompt();
  const r = await installPrompt.userChoice;
  document.getElementById('install-banner').classList.remove('show');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVICE WORKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', () => {
  loadProgress();
  setTimeout(()=>{
    const s=document.getElementById('splash');
    s.style.opacity='0';
    setTimeout(()=>s.style.display='none',500);
  }, 1400);
});
</script>
</body>
</html>
